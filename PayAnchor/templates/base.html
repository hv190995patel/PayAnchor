<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Dashboard{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <style>
    /* Reset and base */
    body, html {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
    }

    /* Layout */
    #sidebar {
      position: fixed;
      top: 56px; /* navbar height */
      left: 0;
      width: 250px;
      height: calc(100vh - 56px);
      background: #2c3e50;
      color: #ecf0f1;
      overflow-y: auto;
      transition: left 0.3s ease;
      z-index: 1050;
      padding-top: 1rem;
    }

    #sidebar.hide {
      left: -260px;
    }

    #sidebar .nav-link {
      color: #ecf0f1;
      font-weight: 500;
      padding: 12px 1.5rem;
      display: flex;
      align-items: center;
      border-left: 4px solid transparent;
      transition: background-color 0.2s, border-color 0.2s;
      cursor: pointer;
    }
    #sidebar .nav-link:hover,
    #sidebar .nav-link.active {
      background-color: #34495e;
      border-left-color: #1abc9c;
      color: #1abc9c;
      text-decoration: none;
    }

    #sidebar .nav-link .bi {
      margin-right: 1rem;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    /* Submenu */
    #sidebar .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background-color: #34495e;
    }
    #sidebar .submenu.show {
      max-height: 500px; /* enough for submenu items */
    }
    #sidebar .submenu .nav-link {
      padding-left: 3.5rem;
      font-weight: 400;
      border-left: none;
      background: #3d566e;
    }
    #sidebar .submenu .nav-link:hover,
    #sidebar .submenu .nav-link.active {
      background-color: #1abc9c;
      color: #fff;
      border-left: none;
    }

    /* Scrollbar styling */
    #sidebar::-webkit-scrollbar {
      width: 8px;
    }
    #sidebar::-webkit-scrollbar-thumb {
      background-color: #1abc9c;
      border-radius: 4px;
    }

    /* Main content */
    #content {
      margin-left: 250px;
      padding: 70px 30px 30px 30px;
      transition: margin-left 0.3s ease;
      min-height: calc(100vh - 56px);
    }
    #sidebar.hide ~ #content {
      margin-left: 0;
    }

    /* Navbar */
    header nav.navbar {
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1100;
      background-color: #34495e !important;
    }

    /* Notifications bell */
    .notification {
      position: relative;
      cursor: pointer;
      font-size: 1.4rem;
      color: #ecf0f1;
      margin-right: 20px;
      user-select: none;
    }
    .notification .badge {
      position: absolute;
      top: -6px;
      right: -8px;
      background-color: #e74c3c;
      color: white;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 50%;
      font-weight: bold;
      pointer-events: none;
    }

    /* Footer */
    footer.footer {
      background: #ecf0f1;
      padding: 12px 20px;
      text-align: center;
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: auto;
    }

    /* Responsive */
    @media (max-width: 992px) {
      #sidebar {
        left: -260px;
      }
      #sidebar.show {
        left: 0;
        box-shadow: 3px 0 6px rgba(0,0,0,0.3);
      }
      #content {
        margin-left: 0;
      }
    }

    /* Accessibility focus */
    #sidebar a:focus {
      outline: 3px solid #1abc9c;
      outline-offset: 2px;
    }

    /* Sidebar toggle button */
    #sidebarToggle {
      background: none;
      border: none;
      color: #ecf0f1;
      font-size: 1.8rem;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <button
          class="d-lg-none"
          id="sidebarToggle"
          aria-label="Toggle sidebar"
          aria-expanded="false"
          aria-controls="sidebar"
        >
          <i class="bi bi-list"></i>
        </button>

        <a class="navbar-brand fw-bold" href="#">PayAnchor</a>

        <div class="d-flex align-items-center ms-auto">
          <div class="notification" role="button" tabindex="0" aria-label="Notifications" title="Notifications">
            <i class="bi bi-bell"></i>
            <span class="badge" id="notificationCount">3</span>
          </div>

          {% if user.is_authenticated %}
          <div class="dropdown">
            <a
              href="#"
              class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
              id="userDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <!-- Replaced user image with icon -->
              <i class="bi bi-person-circle fs-3 me-2"></i>
              <span>{{ user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="">Profile</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="{% url 'Logout' %}">Logout</a></li>
            </ul>
          </div>
          {% else %}
          <a href="{% url 'Login' %}" class="btn btn-outline-light btn-sm">Login</a>
          {% endif %}
        </div>
      </div>
    </nav>
  </header>

  <!-- Sidebar -->
  <nav id="sidebar" aria-label="Sidebar Navigation">
    {% if user.is_authenticated %}
      {% if user.profile.role == 'admin' %}
        <a href="{% url 'admin_home' %}" class="nav-link {% if request.resolver_match.url_name == 'admin_home' %}active{% endif %}">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>

        <!-- Clients submenu -->
        <a
          class="nav-link submenu-toggle"
          href="#clientsSubmenu"
          role="button"
          aria-expanded="false"
          aria-controls="clientsSubmenu"
          id="clientsToggle"
        >
          <i class="bi bi-people"></i> Clients
          <i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <div class="submenu collapse" id="clientsSubmenu" aria-labelledby="clientsToggle" >
          <a href="" class="nav-link {% if request.resolver_match.url_name == 'admin_clients' %}active{% endif %}">All Clients</a>
          <a href="" class="nav-link {% if request.resolver_match.url_name == 'admin_subclients' %}active{% endif %}">Sub-Clients</a>
        </div>

        <a href="" class="nav-link {% if request.resolver_match.url_name == 'admin_employees' %}active{% endif %}">
          <i class="bi bi-person-badge"></i> Employees
        </a>
        <a href="" class="nav-link {% if request.resolver_match.url_name == 'admin_payroll' %}active{% endif %}">
          <i class="bi bi-file-earmark-text"></i> Payroll
        </a>
        <a href="" class="nav-link {% if request.resolver_match.url_name == 'admin_reports' %}active{% endif %}">
          <i class="bi bi-bar-chart-line"></i> Reports
        </a>
      {% elif user.profile.role == 'client' %}
        <a href="{% url 'client_home' %}" class="nav-link {% if request.resolver_match.url_name == 'client_home' %}active{% endif %}">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a href="#" class="nav-link">
          <i class="bi bi-people"></i> My Sub-Clients
        </a>
        <a href="#" class="nav-link">
          <i class="bi bi-person-badge"></i> My Employees
        </a>
        <a href="#" class="nav-link">
          <i class="bi bi-file-earmark-text"></i> Payroll
        </a>
        <a href="#" class="nav-link">
          <i class="bi bi-bar-chart-line"></i> Reports
        </a>
      {% elif user.profile.role == 'subclient' %}
        <a href="#" class="nav-link">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a href="#" class="nav-link">
          <i class="bi bi-person-badge"></i> My Employees
        </a>
        <a href="#" class="nav-link">
          <i class="bi bi-file-earmark-text"></i> Payroll
        </a>
      {% elif user.profile.role == 'employee' %}
        <a href="#" class="nav-link">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
      {% endif %}
    {% endif %}
  </nav>

  <!-- Main content -->
  <main id="content" tabindex="-1">
    {% block content %}
    {% endblock %}
  </main>

  <!-- Footer -->
  <footer class="footer mt-auto">
    <div class="container">
      <small>&copy; {{ current_year }} PayAnchor. All rights reserved.</small>
    </div>
  </footer>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Sidebar toggle button on mobile
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');

    sidebarToggle.addEventListener('click', () => {
      const expanded = sidebarToggle.getAttribute('aria-expanded') === 'true' || false;
      sidebarToggle.setAttribute('aria-expanded', !expanded);
      sidebar.classList.toggle('hide');
    });

    // Submenu toggle for admin clients submenu
    const submenuToggles = document.querySelectorAll('.submenu-toggle');

    submenuToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        e.preventDefault();

        const targetId = toggle.getAttribute('href').substring(1);
        const submenu = document.getElementById(targetId);

        const isShown = submenu.classList.contains('show');
        submenu.classList.toggle('show');
        toggle.setAttribute('aria-expanded', !isShown);

        // Close other submenus if any
        submenuToggles.forEach(otherToggle => {
          if (otherToggle !== toggle) {
            const otherTargetId = otherToggle.getAttribute('href').substring(1);
            const otherSubmenu = document.getElementById(otherTargetId);
            if (otherSubmenu.classList.contains('show')) {
              otherSubmenu.classList.remove('show');
              otherToggle.setAttribute('aria-expanded', false);
            }
          }
        });
      });
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
      if (
        !sidebar.contains(e.target) &&
        !sidebarToggle.contains(e.target) &&
        window.innerWidth <= 992 &&
        !sidebar.classList.contains('hide')
      ) {
        sidebar.classList.add('hide');
        sidebarToggle.setAttribute('aria-expanded', false);
      }
    });

    // Keyboard accessibility for submenu toggles
    submenuToggles.forEach(toggle => {
      toggle.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggle.click();
        }
      });
    });
  </script>
</body>
</html>
